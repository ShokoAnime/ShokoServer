using System.Collections.Generic;
using System.Diagnostics;
using MessagePack;
using Newtonsoft.Json;
using Shoko.Server.MediaInfo;
using Shoko.Server.MediaInfo.Converters;
using Xunit;

namespace Shoko.Tests
{
    public class MediaInfoTest
    {
        public static IEnumerable<object[]> Data => new List<object[]> 
        {
            new object[] {"{\"media\":{\"track\":[{\"type\":0,\"Duration\":1421.067,\"OverallBitRate\":7224832,\"FileExtension\":\"mkv\",\"Format_Version\":4,\"FrameRate\":23.976,\"IsStreamable\":true,\"Encoded_Date\":\"2017-02-13T23:02:52\",\"UniqueID\":\"233047645306169990888854847128758452642\",\"ID\":0,\"Title\":null,\"StreamOrder\":0,\"Format\":\"Matroska\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":null,\"Language\":null,\"LanguageCode\":null,\"LanguageName\":null,\"Default\":false,\"Forced\":false},{\"type\":1,\"Format_Settings_CABAC\":true,\"Format_Settings_BVOP\":false,\"Format_Settings_QPel\":false,\"Format_Settings_GMC\":null,\"Format_Settings_RefFrames\":16,\"BitRate\":4944055,\"Width\":1920,\"Height\":1080,\"PixelAspectRatio\":1.000,\"FrameRate\":23.976,\"FrameRate_Mode\":\"CFR\",\"FrameCount\":34048,\"ColorSpace\":\"YUV\",\"ChromaSubsampling\":\"4:2:0\",\"BitDepth\":10,\"ScanType\":\"Progressive\",\"Encoded_Library_Name\":\"x264\",\"MuxingMode\":null,\"HDR_Format\":null,\"HDR_Format_Compatibility\":null,\"colour_range\":\"Limited\",\"colour_primaries\":\"BT.709\",\"transfer_characteristics\":\"BT.709\",\"matrix_coefficients\":\"BT.709\",\"MasteringDisplay_ColorPrimaries\":null,\"MasteringDisplay_Luminance\":null,\"MaxCLL\":null,\"MaxFALL\":null,\"UniqueID\":\"1\",\"ID\":1,\"Title\":\"[FFF]\",\"StreamOrder\":0,\"Format\":\"AVC\",\"Format_Profile\":\"High 10\",\"Format_Settings\":null,\"Format_Level\":\"5.1\",\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"V_MPEG4/ISO/AVC\",\"Language\":\"ja\",\"LanguageCode\":\"jpn\",\"LanguageName\":\"Japanese\",\"Default\":true,\"Forced\":false},{\"type\":2,\"Channels\":2,\"ChannelLayout\":\"L R\",\"SamplesPerFrame\":4096,\"SamplingRate\":48000,\"Compression_Mode\":\"Lossless\",\"BitRate\":676899,\"BitRate_Mode\":\"VBR\",\"BitDepth\":16,\"extra\":null,\"UniqueID\":\"1726138903677771911\",\"ID\":2,\"Title\":\"English 2.0 FLAC\",\"StreamOrder\":1,\"Format\":\"FLAC\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"A_FLAC\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":true,\"Forced\":false},{\"type\":2,\"Channels\":2,\"ChannelLayout\":\"L R\",\"SamplesPerFrame\":1152,\"SamplingRate\":48000,\"Compression_Mode\":\"Lossless\",\"BitRate\":1604695,\"BitRate_Mode\":\"VBR\",\"BitDepth\":24,\"extra\":null,\"UniqueID\":\"2185306722514264192\",\"ID\":3,\"Title\":\"Japanese 2.0 FLAC\",\"StreamOrder\":2,\"Format\":\"FLAC\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"A_FLAC\",\"Language\":\"ja\",\"LanguageCode\":\"jpn\",\"LanguageName\":\"Japanese\",\"Default\":false,\"Forced\":false},{\"type\":3,\"SubTitle\":null,\"External\":false,\"Filename\":null,\"UniqueID\":\"10870295570374117256\",\"ID\":4,\"Title\":\"Signs/Songs\",\"StreamOrder\":0,\"Format\":\"ASS\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"S_TEXT/ASS\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":true,\"Forced\":false},{\"type\":3,\"SubTitle\":null,\"External\":false,\"Filename\":null,\"UniqueID\":\"15676088853766116264\",\"ID\":5,\"Title\":\"Full Subtitles [Vivid-Watashi]\",\"StreamOrder\":0,\"Format\":\"ASS\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"S_TEXT/ASS\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":false,\"Forced\":false},{\"type\":4,\"extra\":{\"_00_00_00_000\":\"en:Prologue\",\"_00_02_29_024\":\"en:Opening\",\"_00_03_59_030\":\"en:Part A\",\"_00_09_29_110\":\"en:Eyecatch\",\"_00_09_32_113\":\"en:Part B\",\"_00_22_10_079\":\"en:Ending\"},\"UniqueID\":null,\"ID\":0,\"Title\":null,\"StreamOrder\":0,\"Format\":null,\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":null,\"Language\":null,\"LanguageCode\":null,\"LanguageName\":null,\"Default\":false,\"Forced\":false}]},\"General\":{\"type\":0,\"Duration\":1421.067,\"OverallBitRate\":7224832,\"FileExtension\":\"mkv\",\"Format_Version\":4,\"FrameRate\":23.976,\"IsStreamable\":true,\"Encoded_Date\":\"2017-02-13T23:02:52\",\"UniqueID\":\"233047645306169990888854847128758452642\",\"ID\":0,\"Title\":null,\"StreamOrder\":0,\"Format\":\"Matroska\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":null,\"Language\":null,\"LanguageCode\":null,\"LanguageName\":null,\"Default\":false,\"Forced\":false},\"Video\":{\"type\":1,\"Format_Settings_CABAC\":true,\"Format_Settings_BVOP\":false,\"Format_Settings_QPel\":false,\"Format_Settings_GMC\":null,\"Format_Settings_RefFrames\":16,\"BitRate\":4944055,\"Width\":1920,\"Height\":1080,\"PixelAspectRatio\":1.000,\"FrameRate\":23.976,\"FrameRate_Mode\":\"CFR\",\"FrameCount\":34048,\"ColorSpace\":\"YUV\",\"ChromaSubsampling\":\"4:2:0\",\"BitDepth\":10,\"ScanType\":\"Progressive\",\"Encoded_Library_Name\":\"x264\",\"MuxingMode\":null,\"HDR_Format\":null,\"HDR_Format_Compatibility\":null,\"colour_range\":\"Limited\",\"colour_primaries\":\"BT.709\",\"transfer_characteristics\":\"BT.709\",\"matrix_coefficients\":\"BT.709\",\"MasteringDisplay_ColorPrimaries\":null,\"MasteringDisplay_Luminance\":null,\"MaxCLL\":null,\"MaxFALL\":null,\"UniqueID\":\"1\",\"ID\":1,\"Title\":\"[FFF]\",\"StreamOrder\":0,\"Format\":\"AVC\",\"Format_Profile\":\"High 10\",\"Format_Settings\":null,\"Format_Level\":\"5.1\",\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"V_MPEG4/ISO/AVC\",\"Language\":\"ja\",\"LanguageCode\":\"jpn\",\"LanguageName\":\"Japanese\",\"Default\":true,\"Forced\":false},\"Audio\":[{\"type\":2,\"Channels\":2,\"ChannelLayout\":\"L R\",\"SamplesPerFrame\":4096,\"SamplingRate\":48000,\"Compression_Mode\":\"Lossless\",\"BitRate\":676899,\"BitRate_Mode\":\"VBR\",\"BitDepth\":16,\"extra\":null,\"UniqueID\":\"1726138903677771911\",\"ID\":2,\"Title\":\"English 2.0 FLAC\",\"StreamOrder\":1,\"Format\":\"FLAC\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"A_FLAC\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":true,\"Forced\":false},{\"type\":2,\"Channels\":2,\"ChannelLayout\":\"L R\",\"SamplesPerFrame\":1152,\"SamplingRate\":48000,\"Compression_Mode\":\"Lossless\",\"BitRate\":1604695,\"BitRate_Mode\":\"VBR\",\"BitDepth\":24,\"extra\":null,\"UniqueID\":\"2185306722514264192\",\"ID\":3,\"Title\":\"Japanese 2.0 FLAC\",\"StreamOrder\":2,\"Format\":\"FLAC\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"A_FLAC\",\"Language\":\"ja\",\"LanguageCode\":\"jpn\",\"LanguageName\":\"Japanese\",\"Default\":false,\"Forced\":false}],\"Subs\":[{\"type\":3,\"SubTitle\":null,\"External\":false,\"Filename\":null,\"UniqueID\":\"10870295570374117256\",\"ID\":4,\"Title\":\"Signs/Songs\",\"StreamOrder\":0,\"Format\":\"ASS\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"S_TEXT/ASS\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":true,\"Forced\":false},{\"type\":3,\"SubTitle\":null,\"External\":false,\"Filename\":null,\"UniqueID\":\"15676088853766116264\",\"ID\":5,\"Title\":\"Full Subtitles [Vivid-Watashi]\",\"StreamOrder\":0,\"Format\":\"ASS\",\"Format_Profile\":null,\"Format_Settings\":null,\"Format_Level\":null,\"Format_Commercial_IfAny\":null,\"Format_Tier\":null,\"Format_AdditionalFeatures\":null,\"Format_Settings_Endianness\":null,\"Codec\":null,\"CodecID\":\"S_TEXT/ASS\",\"Language\":\"en\",\"LanguageCode\":\"eng\",\"LanguageName\":\"English\",\"Default\":false,\"Forced\":false}],\"Chaptered\":true}" },
        };

        [Theory, MemberData(nameof(Data))]
        public void SerializeTest(string data)
        {
            Stopwatch stopwatch = Stopwatch.StartNew();
            var obj = JsonConvert.DeserializeObject<MediaContainer>(data, new JsonSerializerSettings
            {
                Converters = [new StreamJsonConverter()],
            });
            stopwatch.Stop();
            Debug.WriteLine(stopwatch.Elapsed);
            stopwatch.Restart();
            var serialized = MessagePackSerializer.Serialize(obj);
            stopwatch.Stop();
            Debug.WriteLine(stopwatch.Elapsed);
            stopwatch.Restart();
            var deserialized = MessagePackSerializer.Deserialize<MediaContainer>(serialized);
            stopwatch.Stop();
            Debug.WriteLine(stopwatch.Elapsed);
            Assert.Equal(obj, deserialized);
        }
    }
}
