name: Publish to Docker Hub

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git reference for what to push
        default: master
        required: true
      tag:
        description: Docker tag to push
        default: latest
        required: true

jobs:
  publish_amd64:
    name: Publish docker image for amd64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
        submodules: recursive
        ref: "${{ github.event.inputs.ref }}"
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}-amd64
    - name: Log into docker hub
      run: docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
    - name: Push to Docker Hub
      run: docker push ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}-amd64

  publish_arm64:
    name: Publish docker image for arm64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
        submodules: recursive
        ref: "${{ github.event.inputs.ref }}"
    - uses: docker/setup-qemu-action@v1
      name: Set up QEMU
      with:
        platforms: arm64
    - uses: docker/setup-buildx-action@v1
      name: Set up Docker Buildx
    - name: Log into docker hub
      run: docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
    - name: Build and Push the Docker image
      run: docker buildx build . --file Dockerfile.aarch64 --tag ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}-arm64 --platform linux/arm64 --push

  push_manifest:
    needs: [publish_amd64, publish_arm64]
    name: Push combined tag for both images
    runs-on: ubuntu-latest
    steps:
    - name: Log into docker hub
      run: docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
    - name: Create manifest
      run: docker manifest create ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }} --amend ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}-amd64 --amend ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}-arm64
    - name: Push manifest
      run: docker manifest push ${{ secrets.DOCKER_REPO }}:${{ github.event.inputs.tag }}